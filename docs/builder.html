<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Builder - TREF</title>
  <meta name="description" content="Create your own TREF block - no coding required.">
  <link rel="stylesheet" href="css/tref-site.css?v=0.3.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='6' y='6' width='88' height='88' rx='12' fill='%232D1B4E' stroke='%235CCCCC' stroke-width='5'/></svg>">
</head>
<body>
  <!-- Navigation (rendered by nav.js) -->
  <nav class="nav"></nav>
  <script src="js/nav.js?v=0.3.0"></script>

  <!-- Hero -->
  <section class="hero" style="padding: 2rem;">
    <h1>Build a Block</h1>
    <p class="hero-subtitle" style="font-size: 1.2rem;">
      Create a verifiable knowledge block in 3 easy steps. No coding required.
    </p>
  </section>

  <!-- Builder -->
  <section class="section">
    <div class="container builder-container">

      <div class="step-indicator">
        <div class="step-dot active" id="dot-1"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-dot" id="dot-3"></div>
      </div>

      <div class="builder-form">
        <form id="block-form">
          <!-- Step 1: Content -->
          <div class="form-group">
            <label for="content">Your Content</label>
            <textarea
              class="form-input"
              id="content"
              placeholder="Write your knowledge here...&#10;&#10;Example: The speed of light in a vacuum is exactly 299,792,458 meters per second."
              required
            ></textarea>
            <small>What do you want to share? Facts, quotes, instructions, notes...</small>
          </div>

          <!-- Live Preview Block -->
          <div class="form-group" id="live-preview-group" style="display: none;">
            <label>Your Block (Live Preview)</label>
            <div id="live-preview" style="background: var(--gray-100); border-radius: 8px; padding: 1rem;"></div>
          </div>

          <!-- Step 2: Optional metadata -->
          <div class="form-row">
            <div class="form-group">
              <label for="author">Your Name (optional)</label>
              <input type="text" class="form-input" id="author" placeholder="Jane Doe">
            </div>
            <div class="form-group">
              <label for="source-url">Source URL (optional)</label>
              <input type="url" class="form-input" id="source-url" placeholder="https://example.com/source">
            </div>
          </div>

          <div class="form-group">
            <label for="source-title">Source Title (optional)</label>
            <input type="text" class="form-input" id="source-title" placeholder="Wikipedia: Speed of Light">
            <small>Where did this information come from?</small>
          </div>

          <!-- Step 3: Build -->
          <button type="submit" class="btn btn-primary btn-build">
            Create My Block
          </button>
        </form>
      </div>

      <!-- Result -->
      <div class="result-section" id="result-section">
        <h2 class="section-title" style="margin-bottom: 1.5rem;">Your Block</h2>

        <div class="result-preview">
          <div id="block-preview"></div>
        </div>

        <div class="result-actions">
          <button class="btn btn-primary" id="btn-download">
            Download .tref File
          </button>
          <button class="btn btn-secondary" id="btn-copy">
            Copy JSON
          </button>
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Embed on Your Site</h3>
        <p style="color: var(--gray-600); margin-bottom: 1rem;">
          Copy this code and paste it into your HTML:
        </p>
        <div style="position: relative;">
          <div class="embed-code" id="embed-code"></div>
          <button class="btn-copy-code" id="btn-copy-embed" title="Copy code">Copy</button>
        </div>
      </div>

    </div>
  </section>

  <!-- How it works -->
  <section class="section" style="background: var(--site-section-alt);">
    <div class="container">
      <h2 class="section-title">How It Works</h2>

      <div class="card-grid" style="max-width: 900px; margin: 0 auto;">
        <div class="card">
          <div class="card-icon">1</div>
          <h3>Write Your Content</h3>
          <p>Enter any knowledge you want to preserve - facts, quotes, instructions, or notes.</p>
        </div>
        <div class="card">
          <div class="card-icon">2</div>
          <h3>Add Sources</h3>
          <p>Optionally link to where the information came from. This makes your block trustworthy.</p>
        </div>
        <div class="card">
          <div class="card-icon">3</div>
          <h3>Share Anywhere</h3>
          <p>Download the file, copy the code, or embed directly on your website.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-links">
      <a href="https://github.com/lpmwfx/tref">GitHub</a>
      <a href="https://github.com/lpmwfx/tref/releases">Releases</a>
      <a href="guide.html">Documentation</a>
    </div>
    <p>TREF v0.3.0 | MIT License | <a href="https://github.com/lpmwfx">lpmwfx</a></p>
  </footer>

  <script type="module">
    import { TrefWrapper, publish, getStyles } from './js/browser.js?v=0.3.0';

    // Inject TREF styles
    const style = document.createElement('style');
    style.textContent = getStyles();
    document.head.appendChild(style);

    const form = document.getElementById('block-form');
    const resultSection = document.getElementById('result-section');
    const preview = document.getElementById('block-preview');
    const embedCode = document.getElementById('embed-code');

    let currentWrapper = null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const content = document.getElementById('content').value.trim();
      const author = document.getElementById('author').value.trim();
      const sourceUrl = document.getElementById('source-url').value.trim();
      const sourceTitle = document.getElementById('source-title').value.trim();

      // Build refs array
      const refs = [];
      if (sourceUrl) {
        refs.push({
          type: 'url',
          url: sourceUrl,
          title: sourceTitle || sourceUrl
        });
      }

      // Create block
      const block = await publish(content, {
        author: author || undefined,
        refs: refs.length > 0 ? refs : undefined
      });

      // Create wrapper and display
      currentWrapper = new TrefWrapper(block);
      preview.innerHTML = currentWrapper.toHTML();
      currentWrapper.attachEvents(preview.querySelector('.tref-wrapper'));

      // Generate embed code
      const embedHtml = `<!-- TREF Block -->
<div id="tref-block"></div>
<script type="module">
  import { TrefWrapper } from 'https://cdn.jsdelivr.net/npm/tref-block/dist/tref-block.js?v=0.3.0';

  const block = ${JSON.stringify(block, null, 2)};
  const wrapper = new TrefWrapper(block);
  document.getElementById('tref-block').innerHTML = wrapper.toHTML();
  wrapper.attachEvents(document.querySelector('.tref-wrapper'));
<\/script>
<style>${getStyles()}</style>`;

      embedCode.textContent = embedHtml;

      // Show result
      resultSection.classList.add('visible');
      resultSection.scrollIntoView({ behavior: 'smooth' });

      // Update step indicators
      document.getElementById('dot-1').classList.add('done');
      document.getElementById('dot-2').classList.add('done');
      document.getElementById('dot-3').classList.add('done', 'active');
    });

    // Download button
    document.getElementById('btn-download').addEventListener('click', () => {
      if (!currentWrapper) return;
      const url = currentWrapper.toObjectURL();
      const a = document.createElement('a');
      a.href = url;
      a.download = currentWrapper.getFilename();
      a.click();
      URL.revokeObjectURL(url);
    });

    // Copy JSON button
    document.getElementById('btn-copy').addEventListener('click', async () => {
      if (!currentWrapper) return;
      await currentWrapper.copyToClipboard();
      const btn = document.getElementById('btn-copy');
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy JSON', 2000);
    });

    // Copy embed code button
    document.getElementById('btn-copy-embed').addEventListener('click', async () => {
      await navigator.clipboard.writeText(embedCode.textContent);
      const btn = document.getElementById('btn-copy-embed');
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'Copy';
        btn.classList.remove('copied');
      }, 2000);
    });

    // Update step indicators on input
    document.getElementById('content').addEventListener('input', (e) => {
      if (e.target.value.trim()) {
        document.getElementById('dot-1').classList.add('done');
        document.getElementById('dot-2').classList.add('active');
      }
    });
  </script>
</body>
</html>
