<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Builder - TREF</title>
  <meta name="description" content="Create your own TREF block - no coding required.">
  <link rel="stylesheet" href="css/tref-site.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='6' y='6' width='88' height='88' rx='12' fill='%232D1B4E' stroke='%235CCCCC' stroke-width='5'/></svg>">
  <style>
    .builder-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .builder-form {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--gray-700);
    }
    .form-group small {
      display: block;
      color: var(--gray-500);
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    textarea.form-input {
      min-height: 150px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
    }
    .btn-build {
      width: 100%;
      padding: 1rem;
      font-size: 1.1rem;
    }
    .result-section {
      margin-top: 2rem;
      display: none;
    }
    .result-section.visible {
      display: block;
    }
    .result-preview {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    .result-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .embed-code {
      background: var(--gray-900);
      color: var(--mint);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Fira Code', monospace;
      font-size: 0.85rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--gray-300);
      transition: background 0.3s;
    }
    .step-dot.active {
      background: var(--purple);
    }
    .step-dot.done {
      background: var(--mint);
    }
    .btn-copy-code {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--gray-700);
      color: var(--gray-300);
      border: 1px solid var(--gray-600);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .btn-copy-code:hover {
      background: var(--gray-600);
      color: white;
    }
    .btn-copy-code.copied {
      background: var(--mint);
      color: var(--dark-purple);
      border-color: var(--mint);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="/" class="nav-brand">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <rect x="6" y="6" width="88" height="88" rx="12" ry="12" fill="#2D1B4E" stroke="#5CCCCC" stroke-width="5"/>
          <g transform="translate(50 50) scale(0.022) translate(-1125 -1125)">
            <g transform="translate(0,2250) scale(1,-1)" fill="#5CCCCC">
              <path d="M1515 2244 c-66 -10 -144 -38 -220 -77 -67 -35 -106 -67 -237 -195 -155 -152 -188 -195 -188 -247 0 -41 30 -95 64 -116 39 -24 113 -25 146 -3 14 9 90 81 170 160 183 181 216 199 350 199 83 0 103 -4 155 -28 78 -36 146 -104 182 -181 24 -53 28 -73 28 -151 0 -137 -21 -175 -199 -355 -79 -80 -151 -156 -160 -170 -39 -59 -8 -162 58 -194 81 -38 113 -22 284 147 165 163 230 252 268 370 24 71 28 99 28 202 0 106 -3 130 -28 200 -91 261 -310 428 -579 439 -50 3 -105 2 -122 0z"/>
              <path d="M1395 1585 c-17 -9 -189 -174 -382 -368 -377 -378 -383 -385 -362 -461 21 -76 87 -116 166 -101 33 6 80 49 386 353 191 191 358 362 369 381 26 42 28 109 4 146 -39 59 -118 81 -181 50z"/>
              <path d="M463 1364 c-47 -24 -323 -310 -365 -379 -20 -33 -49 -96 -64 -140 -24 -69 -28 -96 -28 -195 0 -127 14 -190 66 -294 63 -126 157 -220 284 -284 104 -52 167 -66 294 -66 99 0 126 4 195 28 44 15 107 44 140 64 65 39 348 309 371 354 41 78 -10 184 -96 203 -61 13 -98 -11 -256 -166 -186 -183 -222 -204 -359 -204 -77 0 -98 4 -147 27 -79 37 -142 98 -181 177 -29 59 -32 74 -32 156 0 136 21 174 199 355 79 80 150 156 159 170 23 33 22 107 -2 146 -35 57 -115 79 -178 48z"/>
            </g>
          </g>
        </svg>
        TREF
      </a>
      <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="builder.html" class="active">Builder</a></li>
        <li><a href="examples.html">Examples</a></li>
        <li><a href="guide.html">Guide</a></li>
        <li><a href="about-cli.html">About</a></li>
      </ul>
      <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">&#127769;</span>
      </button>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero" style="padding: 2rem;">
    <h1>Build a Block</h1>
    <p class="hero-subtitle" style="font-size: 1.2rem;">
      Create a verifiable knowledge block in 3 easy steps. No coding required.
    </p>
  </section>

  <!-- Builder -->
  <section class="section">
    <div class="container builder-container">

      <div class="step-indicator">
        <div class="step-dot active" id="dot-1"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-dot" id="dot-3"></div>
      </div>

      <div class="builder-form">
        <form id="block-form">
          <!-- Step 1: Content -->
          <div class="form-group">
            <label for="content">Your Content</label>
            <textarea
              class="form-input"
              id="content"
              placeholder="Write your knowledge here...&#10;&#10;Example: The speed of light in a vacuum is exactly 299,792,458 meters per second."
              required
            ></textarea>
            <small>What do you want to share? Facts, quotes, instructions, notes...</small>
          </div>

          <!-- Live Preview Block -->
          <div class="form-group" id="live-preview-group" style="display: none;">
            <label>Your Block (Live Preview)</label>
            <div id="live-preview" style="background: var(--gray-100); border-radius: 8px; padding: 1rem;"></div>
          </div>

          <!-- Step 2: Optional metadata -->
          <div class="form-row">
            <div class="form-group">
              <label for="author">Your Name (optional)</label>
              <input type="text" class="form-input" id="author" placeholder="Jane Doe">
            </div>
            <div class="form-group">
              <label for="source-url">Source URL (optional)</label>
              <input type="url" class="form-input" id="source-url" placeholder="https://example.com/source">
            </div>
          </div>

          <div class="form-group">
            <label for="source-title">Source Title (optional)</label>
            <input type="text" class="form-input" id="source-title" placeholder="Wikipedia: Speed of Light">
            <small>Where did this information come from?</small>
          </div>

          <!-- Step 3: Build -->
          <button type="submit" class="btn btn-primary btn-build">
            Create My Block
          </button>
        </form>
      </div>

      <!-- Result -->
      <div class="result-section" id="result-section">
        <h2 class="section-title" style="margin-bottom: 1.5rem;">Your Block</h2>

        <div class="result-preview">
          <div id="block-preview"></div>
        </div>

        <div class="result-actions">
          <button class="btn btn-primary" id="btn-download">
            Download .tref File
          </button>
          <button class="btn btn-secondary" id="btn-copy">
            Copy JSON
          </button>
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Embed on Your Site</h3>
        <p style="color: var(--gray-600); margin-bottom: 1rem;">
          Copy this code and paste it into your HTML:
        </p>
        <div style="position: relative;">
          <div class="embed-code" id="embed-code"></div>
          <button class="btn-copy-code" id="btn-copy-embed" title="Copy code">Copy</button>
        </div>
      </div>

    </div>
  </section>

  <!-- How it works -->
  <section class="section" style="background: white;">
    <div class="container">
      <h2 class="section-title">How It Works</h2>

      <div class="card-grid" style="max-width: 900px; margin: 0 auto;">
        <div class="card">
          <div class="card-icon">1</div>
          <h3>Write Your Content</h3>
          <p>Enter any knowledge you want to preserve - facts, quotes, instructions, or notes.</p>
        </div>
        <div class="card">
          <div class="card-icon">2</div>
          <h3>Add Sources</h3>
          <p>Optionally link to where the information came from. This makes your block trustworthy.</p>
        </div>
        <div class="card">
          <div class="card-icon">3</div>
          <h3>Share Anywhere</h3>
          <p>Download the file, copy the code, or embed directly on your website.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-links">
      <a href="https://github.com/lpmwfx/TRefBlocks">GitHub</a>
      <a href="https://github.com/lpmwfx/TRefBlocks/releases">Releases</a>
      <a href="guide.html">Documentation</a>
    </div>
    <p>TREF v0.1.0 | MIT License | <a href="https://github.com/lpmwfx">lpmwfx</a></p>
  </footer>

  <script type="module">
    import { TrefWrapper, publish, getStyles } from './js/browser.js';

    // Inject TREF styles
    const style = document.createElement('style');
    style.textContent = getStyles();
    document.head.appendChild(style);

    // Theme toggle
    window.toggleTheme = function() {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      document.getElementById('theme-icon').innerHTML = isDark ? '&#9728;' : '&#127769;';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
      document.getElementById('theme-icon').innerHTML = '&#9728;';
    }

    const form = document.getElementById('block-form');
    const resultSection = document.getElementById('result-section');
    const preview = document.getElementById('block-preview');
    const embedCode = document.getElementById('embed-code');

    let currentWrapper = null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const content = document.getElementById('content').value.trim();
      const author = document.getElementById('author').value.trim();
      const sourceUrl = document.getElementById('source-url').value.trim();
      const sourceTitle = document.getElementById('source-title').value.trim();

      // Build refs array
      const refs = [];
      if (sourceUrl) {
        refs.push({
          type: 'url',
          url: sourceUrl,
          title: sourceTitle || sourceUrl
        });
      }

      // Create block
      const block = await publish(content, {
        author: author || undefined,
        refs: refs.length > 0 ? refs : undefined
      });

      // Create wrapper and display
      currentWrapper = new TrefWrapper(block);
      preview.innerHTML = currentWrapper.toHTML();
      currentWrapper.attachEvents(preview.querySelector('.tref-wrapper'));

      // Generate embed code
      const embedHtml = `<!-- TREF Block -->
<div id="tref-block"></div>
<script type="module">
  import { TrefWrapper } from 'https://cdn.jsdelivr.net/npm/tref-block/dist/tref-block.js';

  const block = ${JSON.stringify(block, null, 2)};
  const wrapper = new TrefWrapper(block);
  document.getElementById('tref-block').innerHTML = wrapper.toHTML();
  wrapper.attachEvents(document.querySelector('.tref-wrapper'));
<\/script>
<style>${getStyles()}</style>`;

      embedCode.textContent = embedHtml;

      // Show result
      resultSection.classList.add('visible');
      resultSection.scrollIntoView({ behavior: 'smooth' });

      // Update step indicators
      document.getElementById('dot-1').classList.add('done');
      document.getElementById('dot-2').classList.add('done');
      document.getElementById('dot-3').classList.add('done', 'active');
    });

    // Download button
    document.getElementById('btn-download').addEventListener('click', () => {
      if (!currentWrapper) return;
      const url = currentWrapper.toObjectURL();
      const a = document.createElement('a');
      a.href = url;
      a.download = currentWrapper.getFilename();
      a.click();
      URL.revokeObjectURL(url);
    });

    // Copy JSON button
    document.getElementById('btn-copy').addEventListener('click', async () => {
      if (!currentWrapper) return;
      await currentWrapper.copyToClipboard();
      const btn = document.getElementById('btn-copy');
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy JSON', 2000);
    });

    // Copy embed code button
    document.getElementById('btn-copy-embed').addEventListener('click', async () => {
      await navigator.clipboard.writeText(embedCode.textContent);
      const btn = document.getElementById('btn-copy-embed');
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'Copy';
        btn.classList.remove('copied');
      }, 2000);
    });

    // Update step indicators on input
    document.getElementById('content').addEventListener('input', (e) => {
      if (e.target.value.trim()) {
        document.getElementById('dot-1').classList.add('done');
        document.getElementById('dot-2').classList.add('active');
      }
    });
  </script>
</body>
</html>
