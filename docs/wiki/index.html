<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TREF Manual</title>
  <link rel="stylesheet" href="../css/tref-site.css">
  <link rel="stylesheet" href="wiki.css">
  <link rel="icon" href="../img/favicon.ico">
  <style id="tref-styles"></style>
  <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
  <nav class="nav"></nav>
  <script src="../js/nav.js"></script>

  <!-- Mobile menu button -->
  <button class="wiki-menu-btn" id="wiki-menu-btn" aria-label="Open menu">
    <span>&#9776;</span>
  </button>

  <!-- Mobile overlay -->
  <div class="wiki-overlay" id="wiki-overlay"></div>

  <div class="wiki-layout">
    <aside class="wiki-sidebar" id="wiki-sidebar"></aside>
    <main class="wiki-main">
      <article class="wiki-article">
        <div id="wiki-content"></div>
        <div id="wiki-tref"></div>
      </article>
    </main>
  </div>

  <script type="module">
    import { TrefWrapper } from '../js/tref-block.js';

    // Inject TrefWrapper CSS
    document.getElementById('tref-styles').textContent = TrefWrapper.getStyles();

    try {
      // Load sidebar
      const pagesRes = await fetch('_pages.json');
      if (!pagesRes.ok) throw new Error('Failed to load _pages.json: ' + pagesRes.status);
      const pagesData = await pagesRes.json();
      renderSidebar(document.getElementById('wiki-sidebar'), pagesData, 'home');

      // Load home block
      const blockRes = await fetch('blocks/home.json');
      if (!blockRes.ok) throw new Error('Failed to load blocks/home.json: ' + blockRes.status);
      const block = await blockRes.json();

      // Render content
      document.getElementById('wiki-content').innerHTML = renderMarkdown(block.content);

      // Apply syntax highlighting (ignore security warning - content is escaped in HTML)
      hljs.configure({ ignoreUnescapedHTML: true });
      document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));

      // Show TREF wrapper
      const wrapper = new TrefWrapper(block);
      document.getElementById('wiki-tref').innerHTML = wrapper.toHTML();
      wrapper.attachEvents(document.querySelector('.tref-wrapper'));
    } catch (err) {
      console.error('Wiki load error:', err);
      document.getElementById('wiki-content').innerHTML = '<p style="color:red">Error: ' + err.message + '</p>';
    }

    // Sidebar renderer with collapsible sections
    function renderSidebar(container, data, currentSlug) {
      const sections = {};
      const noSection = [];

      for (const page of data.pages) {
        if (page.section) {
          if (!sections[page.section]) sections[page.section] = [];
          sections[page.section].push(page);
        } else {
          noSection.push(page);
        }
      }

      let html = '<nav class="wiki-nav">';
      html += '<button class="wiki-close-btn" aria-label="Close menu">&times;</button>';
      html += '<h2 class="wiki-nav-title">' + data.title + '</h2>';

      // Pages without section (top-level)
      for (const page of noSection) {
        const active = page.slug === currentSlug ? ' active' : '';
        html += '<a href="pages/' + page.slug + '.html" class="wiki-link top-level' + active + '">' + page.title + '</a>';
      }

      // Sections with collapsible content
      let sectionIndex = 0;
      for (const [section, pages] of Object.entries(sections)) {
        const hasActive = pages.some(p => p.slug === currentSlug);
        const collapsed = !hasActive ? ' collapsed' : '';
        html += '<h3 class="wiki-section' + collapsed + '" data-section="' + sectionIndex + '">' + section + '</h3>';
        html += '<div class="wiki-section-content' + collapsed + '" data-section="' + sectionIndex + '">';
        for (const page of pages) {
          const active = page.slug === currentSlug ? ' active' : '';
          html += '<a href="pages/' + page.slug + '.html" class="wiki-link' + active + '">' + page.title + '</a>';
        }
        html += '</div>';
        sectionIndex++;
      }

      html += '</nav>';
      container.innerHTML = html;

      // Add click handlers for collapsible sections
      container.querySelectorAll('.wiki-section').forEach(el => {
        el.addEventListener('click', () => {
          const idx = el.dataset.section;
          el.classList.toggle('collapsed');
          container.querySelector('.wiki-section-content[data-section="' + idx + '"]').classList.toggle('collapsed');
        });
      });

      // Mobile menu toggle
      const menuBtn = document.getElementById('wiki-menu-btn');
      const overlay = document.getElementById('wiki-overlay');
      const closeBtn = container.querySelector('.wiki-close-btn');

      function openMenu() {
        container.classList.add('open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeMenu() {
        container.classList.remove('open');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      menuBtn.addEventListener('click', openMenu);
      overlay.addEventListener('click', closeMenu);
      if (closeBtn) closeBtn.addEventListener('click', closeMenu);

      // Close on link click (mobile navigation)
      container.querySelectorAll('.wiki-link').forEach(link => {
        link.addEventListener('click', closeMenu);
      });
    }

    // Simple markdown renderer
    function renderMarkdown(md) {
      return md
        .replace(/```(\w*)[\r\n]+([\s\S]*?)```/g, (_, lang, code) => {
          const langClass = lang ? 'language-' + lang : '';
          return '<pre><code class="' + langClass + '">' + escapeHtml(code.trim()) + '</code></pre>';
        })
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        .replace(/^---$/gm, '<hr>')
        .replace(/^\* (.+)$/gm, '<li>$1</li>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>\n?)+/g, match => '<ul>' + match + '</ul>')
        .split('\n').map(line => {
          if (line.trim() === '' || line.startsWith('<')) return line;
          return '<p>' + line + '</p>';
        }).join('\n')
        .replace(/<p><\/p>/g, '');
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>
