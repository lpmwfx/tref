"use strict";var TREF=(()=>{var g=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var O=(r,t)=>{for(var e in t)g(r,e,{get:t[e],enumerable:!0})},R=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of S(t))!D.call(r,a)&&a!==e&&g(r,a,{get:()=>t[a],enumerable:!(n=T(t,a))||n.enumerable});return r};var B=r=>R(g({},"__esModule",{value:!0}),r);var I={};O(I,{TREF_ICON_SVG:()=>v,TREF_MIME_TYPE:()=>l,TrefReceiver:()=>f,TrefWrapper:()=>c,createDraft:()=>u,derive:()=>k,getStyles:()=>E,publish:()=>C,unwrap:()=>y,validate:()=>w,wrap:()=>L});var v=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="24" height="24">
  <rect x="6" y="6" width="88" height="88" rx="12" ry="12" fill="#2D1B4E" stroke="#5CCCCC" stroke-width="5"/>
  <g transform="translate(50 50) scale(0.022) translate(-1125 -1125)">
    <g transform="translate(0,2250) scale(1,-1)" fill="#5CCCCC">
      <path d="M1515 2244 c-66 -10 -144 -38 -220 -77 -67 -35 -106 -67 -237 -195 -155 -152 -188 -195 -188 -247 0 -41 30 -95 64 -116 39 -24 113 -25 146 -3 14 9 90 81 170 160 183 181 216 199 350 199 83 0 103 -4 155 -28 78 -36 146 -104 182 -181 24 -53 28 -73 28 -151 0 -137 -21 -175 -199 -355 -79 -80 -151 -156 -160 -170 -39 -59 -8 -162 58 -194 81 -38 113 -22 284 147 165 163 230 252 268 370 24 71 28 99 28 202 0 106 -3 130 -28 200 -91 261 -310 428 -579 439 -50 3 -105 2 -122 0z"/>
      <path d="M1395 1585 c-17 -9 -189 -174 -382 -368 -377 -378 -383 -385 -362 -461 21 -76 87 -116 166 -101 33 6 80 49 386 353 191 191 358 362 369 381 26 42 28 109 4 146 -39 59 -118 81 -181 50z"/>
      <path d="M463 1364 c-47 -24 -323 -310 -365 -379 -20 -33 -49 -96 -64 -140 -24 -69 -28 -96 -28 -195 0 -127 14 -190 66 -294 63 -126 157 -220 284 -284 104 -52 167 -66 294 -66 99 0 126 4 195 28 44 15 107 44 140 64 65 39 348 309 371 354 41 78 -10 184 -96 203 -61 13 -98 -11 -256 -166 -186 -183 -222 -204 -359 -204 -77 0 -98 4 -147 27 -79 37 -142 98 -181 177 -29 59 -32 74 -32 156 0 136 21 174 199 355 79 80 150 156 159 170 23 33 22 107 -2 146 -35 57 -115 79 -178 48z"/>
    </g>
  </g>
</svg>`,l="application/vnd.aiblocks.tref+json";function b(r){if(Array.isArray(r))return r.map(b);if(r!==null&&typeof r=="object"){let t={},e=r;for(let n of Object.keys(e).sort())t[n]=b(e[n]);return t}return r}function $(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function j(r){let t=new TextEncoder,e=await crypto.subtle.digest("SHA-256",t.encode(r));return Array.from(new Uint8Array(e)).map(n=>n.toString(16).padStart(2,"0")).join("")}function u(r,t={}){let e={v:1,content:r,meta:{created:new Date().toISOString(),license:t.license||"CC-BY-4.0"}};return t.author&&(e.meta.author=t.author),t.refs&&t.refs.length>0&&(e.refs=t.refs),t.parent&&(e.parent=t.parent),e}async function x(r){let t=JSON.stringify(b(r));return`sha256:${await j(t)}`}async function C(r,t={}){let e=u(r,t),n=await x(e);return{...e,id:n}}async function k(r,t,e={}){let n=[...r.refs||[],...e.refs||[]],a=u(t,{author:e.author,license:e.license||r.meta.license,refs:n.length>0?n:void 0,parent:r.id}),s=await x(a);return{...a,id:s}}async function w(r){try{let{id:t,...e}=r,n=await x(e);return t!==n?{valid:!1,error:`ID mismatch: expected ${n}`}:{valid:!0}}catch(t){return{valid:!1,error:t instanceof Error?t.message:String(t)}}}var c=class{#t;constructor(t){if(!t||t.v!==1||!t.id||!t.content)throw new Error("Invalid TREF block");this.#t=t}get block(){return this.#t}get id(){return this.#t.id}get shortId(){return this.#t.id.replace("sha256:","").slice(0,8)}get content(){return this.#t.content}toJSON(t={}){return t.pretty?JSON.stringify(this.#t,null,2):JSON.stringify(this.#t)}getFilename(){return this.#t.id.replace("sha256:","")+".tref"}toBlob(){return new Blob([this.toJSON()],{type:l})}toObjectURL(){return URL.createObjectURL(this.toBlob())}async copyToClipboard(){await navigator.clipboard.writeText(this.toJSON())}async copyContentToClipboard(){await navigator.clipboard.writeText(this.#t.content)}getDragData(){let t=this.toJSON();return[{type:l,data:t},{type:"application/json",data:t},{type:"text/plain",data:t}]}setDragData(t){for(let{type:e,data:n}of this.getDragData())t.setData(e,n)}toHTML(t={}){let{maxContentLength:e=200,interactive:n=!0}=t,a=this.#t.content.length>e?this.#t.content.slice(0,e)+"...":this.#t.content,s=this.#t.refs&&this.#t.refs.length>0?`<div class="tref-refs">
        <strong>Refs:</strong> ${this.#t.refs.filter(i=>i.type==="url"&&i.url).map(i=>`<a href="${i.url}" target="_blank">${i.label||i.url}</a>`).join(", ")}
      </div>`:"",p=n?`<div class="tref-menu">
        <button class="tref-menu-btn" title="Actions">\u22EE</button>
        <div class="tref-menu-dropdown">
          <button class="tref-action" data-action="copy-content">\u{1F4CB} Copy Content</button>
          <button class="tref-action" data-action="copy-json">\u{1F4C4} Copy JSON</button>
          <button class="tref-action" data-action="download">\u2B07\uFE0F Download .tref</button>
          <button class="tref-action" data-action="verify">\u2713 Verify Block</button>
        </div>
      </div>`:"";return`<div class="tref-wrapper" data-tref-id="${this.#t.id}">
  <div class="tref-header">
    <span class="tref-icon">${v}</span>
    <span class="tref-id">${this.shortId}</span>
    <span class="tref-meta">${this.#t.meta.created.split("T")[0]}</span>
    ${p}
  </div>
  <div class="tref-content">${$(a)}</div>
  ${s}
</div>`}attachEvents(t){let e=t.querySelector(".tref-menu-btn"),n=t.querySelector(".tref-menu-dropdown"),a=this;e&&n&&(e.addEventListener("click",s=>{s.stopPropagation(),n.classList.toggle("show")}),document.addEventListener("click",()=>{n.classList.remove("show")})),t.querySelectorAll(".tref-action").forEach(s=>{s.addEventListener("click",async p=>{p.stopPropagation();let i=p.currentTarget.dataset.action,o=t.querySelector(".tref-id"),m=o?.textContent||"";try{switch(i){case"copy-content":await a.copyContentToClipboard(),o&&(o.textContent="Copied!");break;case"copy-json":await a.copyToClipboard(),o&&(o.textContent="Copied!");break;case"download":{let d=a.toObjectURL(),h=document.createElement("a");h.href=d,h.download=a.getFilename(),h.click(),URL.revokeObjectURL(d),o&&(o.textContent="Downloaded!");break}case"verify":{let d=await w(a.block);o&&(o.textContent=d?"\u2713 Valid!":"\u2717 Invalid");break}}setTimeout(()=>{o&&(o.textContent=m)},1500)}catch{o&&(o.textContent="Error"),setTimeout(()=>{o&&(o.textContent=m)},1500)}n&&n.classList.remove("show")})})}static getStyles(){return`
.tref-wrapper {
  font-family: system-ui, -apple-system, sans-serif;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  background: #fafafa;
  max-width: 400px;
  position: relative;
}
.tref-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.tref-icon { display: inline-flex; width: 24px; height: 24px; }
.tref-icon svg { width: 100%; height: 100%; }
.tref-id {
  font-family: monospace;
  font-size: 12px;
  color: #6b7280;
  background: #e5e7eb;
  padding: 2px 6px;
  border-radius: 4px;
  transition: all 0.2s;
}
.tref-meta { font-size: 12px; color: #9ca3af; }
.tref-menu { margin-left: auto; position: relative; }
.tref-menu-btn {
  background: transparent;
  border: none;
  font-size: 18px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  color: #6b7280;
  line-height: 1;
}
.tref-menu-btn:hover { background: #e5e7eb; }
.tref-menu-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  min-width: 160px;
  z-index: 100;
  overflow: hidden;
}
.tref-menu-dropdown.show { display: block; }
.tref-action {
  display: block;
  width: 100%;
  padding: 10px 14px;
  border: none;
  background: white;
  text-align: left;
  cursor: pointer;
  font-size: 13px;
  color: #374151;
}
.tref-action:hover { background: #f3f4f6; }
.tref-action:not(:last-child) { border-bottom: 1px solid #f3f4f6; }
.tref-content {
  font-size: 14px;
  line-height: 1.5;
  color: #374151;
  white-space: pre-wrap;
  word-break: break-word;
}
.tref-refs {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #e5e7eb;
  font-size: 12px;
  color: #6b7280;
}
.tref-refs a { color: #5CCCCC; text-decoration: none; }
.tref-refs a:hover { text-decoration: underline; }
.tref-wrapper[draggable="true"] { cursor: grab; }
.tref-wrapper[draggable="true"]:active { cursor: grabbing; }`}},f=class{#t;#r;#e;constructor(t,e={}){this.#t=t,this.#r=e.onReceive||(()=>{}),this.#e=e.onError||(()=>{}),this.#n()}#n(){let t=this.#t;t.classList.add("tref-receiver"),t.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="copy"),t.classList.add("tref-receiver-active")}),t.addEventListener("dragleave",()=>{t.classList.remove("tref-receiver-active")}),t.addEventListener("drop",e=>{if(e.preventDefault(),t.classList.remove("tref-receiver-active"),!e.dataTransfer){this.#e(new Error("No data"));return}let n=y(e.dataTransfer);n?(t.classList.add("tref-receiver-success"),setTimeout(()=>t.classList.remove("tref-receiver-success"),1e3),this.#r(n)):(t.classList.add("tref-receiver-error"),setTimeout(()=>t.classList.remove("tref-receiver-error"),1e3),this.#e(new Error("Invalid TREF data")))})}get element(){return this.#t}showBlock(t){this.#t.innerHTML=t.toHTML(),this.#t.classList.add("tref-receiver-has-block")}clear(){this.#t.innerHTML=this.#t.dataset.placeholder||"Drop TREF here",this.#t.classList.remove("tref-receiver-has-block")}static getStyles(){return`
.tref-receiver {
  border: 2px dashed #5CCCCC;
  border-radius: 8px;
  padding: 20px;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #6b7280;
  background: #f9fafb;
  transition: all 0.2s;
}
.tref-receiver-active {
  border-color: #8B5CF6;
  background: #f3e8ff;
  color: #8B5CF6;
}
.tref-receiver-success {
  border-color: #10B981;
  background: #ecfdf5;
}
.tref-receiver-error {
  border-color: #ef4444;
  background: #fef2f2;
}
.tref-receiver-has-block {
  border-style: solid;
  background: white;
}`}};function L(r){return new c(r)}function y(r){try{let t;if(typeof r=="string"?t=r:r&&typeof r.getData=="function"&&(t=r.getData(l)||r.getData("application/json")||r.getData("text/plain")),!t)return null;let e=JSON.parse(t);return e.v===1&&e.id&&e.content?new c(e):null}catch{return null}}function E(){return c.getStyles()+f.getStyles()}typeof window<"u"&&(window.TREF={TrefWrapper:c,TrefReceiver:f,publish:C,derive:k,validate:w,createDraft:u,wrap:L,unwrap:y,getStyles:E,TREF_ICON_SVG:v,TREF_MIME_TYPE:l});return B(I);})();
