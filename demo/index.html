<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TREF Demo</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
      color: #1f2937;
    }

    h1 {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #2D1B4E;
    }

    h1 svg { width: 40px; height: 40px; }

    /* Article block - the main content container */
    .article {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .article-content {
      line-height: 1.6;
    }

    .article-content h2 {
      margin-top: 0;
      color: #2D1B4E;
    }

    .article-refs {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
      font-size: 14px;
      color: #6b7280;
    }

    .article-refs a {
      color: #5CCCCC;
      text-decoration: none;
    }

    .article-refs a:hover {
      text-decoration: underline;
    }

    /* TREF icon position - outside, below article, right-aligned */
    .article-tref {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    /* Editor section */
    .editor {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .editor h2 {
      margin-top: 0;
      color: #2D1B4E;
      border-bottom: 2px solid #5CCCCC;
      padding-bottom: 10px;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #5CCCCC;
    }

    button.primary {
      background: #2D1B4E;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    button.primary:hover { background: #3d2a5e; }

    /* Drop zone */
    .drop-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .drop-section h2 {
      margin-top: 0;
      color: #2D1B4E;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2D1B4E;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
  <style id="tref-styles"></style>
</head>
<body>
  <h1>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
      <rect x="6" y="6" width="88" height="88" rx="12" ry="12" fill="#2D1B4E" stroke="#5CCCCC" stroke-width="5"/>
      <g transform="translate(50 50) scale(0.022) translate(-1125 -1125)">
        <g transform="translate(0,2250) scale(1,-1)" fill="#5CCCCC">
          <path d="M1515 2244 c-66 -10 -144 -38 -220 -77 -67 -35 -106 -67 -237 -195 -155 -152 -188 -195 -188 -247 0 -41 30 -95 64 -116 39 -24 113 -25 146 -3 14 9 90 81 170 160 183 181 216 199 350 199 83 0 103 -4 155 -28 78 -36 146 -104 182 -181 24 -53 28 -73 28 -151 0 -137 -21 -175 -199 -355 -79 -80 -151 -156 -160 -170 -39 -59 -8 -162 58 -194 81 -38 113 -22 284 147 165 163 230 252 268 370 24 71 28 99 28 202 0 106 -3 130 -28 200 -91 261 -310 428 -579 439 -50 3 -105 2 -122 0z"/>
          <path d="M1395 1585 c-17 -9 -189 -174 -382 -368 -377 -378 -383 -385 -362 -461 21 -76 87 -116 166 -101 33 6 80 49 386 353 191 191 358 362 369 381 26 42 28 109 4 146 -39 59 -118 81 -181 50z"/>
          <path d="M463 1364 c-47 -24 -323 -310 -365 -379 -20 -33 -49 -96 -64 -140 -24 -69 -28 -96 -28 -195 0 -127 14 -190 66 -294 63 -126 157 -220 284 -284 104 -52 167 -66 294 -66 99 0 126 4 195 28 44 15 107 44 140 64 65 39 348 309 371 354 41 78 -10 184 -96 203 -61 13 -98 -11 -256 -166 -186 -183 -222 -204 -359 -204 -77 0 -98 4 -147 27 -79 37 -142 98 -181 177 -29 59 -32 74 -32 156 0 136 21 174 199 355 79 80 150 156 159 170 23 33 22 107 -2 146 -35 57 -115 79 -178 48z"/>
        </g>
      </g>
    </svg>
    TREF Demo
  </h1>

  <div id="sr-announcements" class="sr-only" aria-live="polite"></div>

  <!-- The Article (with TREF block in corner) -->
  <article class="article" id="article-block" style="display: none;">
    <div class="article-content" id="article-content"></div>
    <div class="article-refs" id="article-refs"></div>
    <div class="article-tref" id="article-tref"></div>
  </article>

  <!-- Editor -->
  <div class="editor">
    <h2>Create Article</h2>
    <textarea id="content-input" rows="8">## What is TREF?

TREF (Traceable Reference Format) is an open format for knowledge with traceable origin.

The chain link icon in the corner IS the block. Hover for actions, drag to share.</textarea>

    <h3 style="margin-bottom: 8px; font-size: 14px; color: #6b7280;">References (one per line)</h3>
    <textarea id="refs-input" rows="2" placeholder="https://example.com">https://tref.lpmwfx.com
https://en.wikipedia.org/wiki/Content-addressable_storage</textarea>

    <div style="margin-top: 16px;">
      <button class="primary" onclick="createArticle()">Publish</button>
    </div>
  </div>

  <!-- Drop Zone -->
  <div class="drop-section">
    <h2>Drop Zone</h2>
    <p style="color: #6b7280; margin-bottom: 16px;">Drag a TREF block here to view it:</p>
    <div id="drop-zone" data-placeholder="Drop TREF block here"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import {
      TrefWrapper,
      TrefReceiver,
      wrap,
      TREF_MIME_TYPE
    } from '../src/wrapper/wrapper.js';

    // Inject wrapper styles
    document.getElementById('tref-styles').textContent =
      TrefWrapper.getStyles() + TrefReceiver.getStyles();

    // Simple markdown to HTML (headers, bold, links, lists)
    function renderMarkdown(md) {
      return md
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        .replace(/^(.+)$/gm, (m) => m.startsWith('<') ? m : `<p>${m}</p>`);
    }

    // Crypto helpers
    function sortKeys(obj) {
      if (Array.isArray(obj)) return obj.map(sortKeys);
      if (obj !== null && typeof obj === 'object') {
        const sorted = {};
        for (const key of Object.keys(obj).sort()) sorted[key] = sortKeys(obj[key]);
        return sorted;
      }
      return obj;
    }

    async function sha256(data) {
      const buffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(data));
      return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function generateId(block) {
      const copy = { ...block };
      delete copy.id;
      return `sha256:${await sha256(JSON.stringify(sortKeys(copy)))}`;
    }

    // Toast
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    // Create article with TREF block
    window.createArticle = async function() {
      const content = document.getElementById('content-input').value.trim();
      const refsText = document.getElementById('refs-input').value.trim();

      if (!content) {
        showToast('Enter some content');
        return;
      }

      // Parse refs
      const refs = refsText.split('\n')
        .map(l => l.trim())
        .filter(l => l.startsWith('http'))
        .map(url => ({ type: 'url', url }));

      // Create block
      const draft = {
        v: 1,
        content,
        meta: { created: new Date().toISOString(), license: 'CC0-1.0' },
        refs: refs.length ? refs : undefined
      };

      const id = await generateId(draft);
      const block = { ...draft, id };
      const wrapper = wrap(block);

      // Render article
      document.getElementById('article-block').style.display = 'block';
      document.getElementById('article-content').innerHTML = renderMarkdown(content);

      // Render refs
      const refsEl = document.getElementById('article-refs');
      if (refs.length) {
        refsEl.innerHTML = '<strong>References:</strong><br>' +
          refs.map(r => `<a href="${r.url}" target="_blank">${r.url}</a>`).join('<br>');
        refsEl.style.display = 'block';
      } else {
        refsEl.style.display = 'none';
      }

      // Render TREF icon in corner
      const trefEl = document.getElementById('article-tref');
      trefEl.innerHTML = wrapper.toHTML();
      wrapper.attachEvents(trefEl);

      showToast('Published: ' + wrapper.shortId);
    };

    // Drop zone
    new TrefReceiver(document.getElementById('drop-zone'), {
      onReceive: (wrapper) => {
        showToast('Received: ' + wrapper.shortId);

        // Show received content as new article
        const content = wrapper.content;
        const refs = wrapper.block.refs || [];

        document.getElementById('article-block').style.display = 'block';
        document.getElementById('article-content').innerHTML = renderMarkdown(content);

        const refsEl = document.getElementById('article-refs');
        if (refs.length) {
          refsEl.innerHTML = '<strong>References:</strong><br>' +
            refs.map(r => `<a href="${r.url}" target="_blank">${r.url}</a>`).join('<br>');
          refsEl.style.display = 'block';
        } else {
          refsEl.style.display = 'none';
        }

        const trefEl = document.getElementById('article-tref');
        trefEl.innerHTML = wrapper.toHTML();
        wrapper.attachEvents(trefEl);
      },
      onError: () => showToast('Invalid TREF data')
    });

    // Auto-create on load
    createArticle();
  </script>
</body>
</html>
