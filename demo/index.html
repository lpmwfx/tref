<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TREF Demo</title>
  <style>
    * { box-sizing: border-box; }

    :root {
      --demo-bg: #f5f5f5;
      --demo-text: #1f2937;
      --demo-heading: #2D1B4E;
      --demo-card-bg: #ffffff;
      --demo-card-shadow: 0 2px 8px rgba(0,0,0,0.1);
      --demo-border: #e5e7eb;
      --demo-muted: #6b7280;
      --demo-input-bg: #ffffff;
      --demo-input-border: #e5e7eb;
    }

    html.dark {
      --demo-bg: #111827;
      --demo-text: #e5e7eb;
      --demo-heading: #a78bfa;
      --demo-card-bg: #1f2937;
      --demo-card-shadow: 0 2px 8px rgba(0,0,0,0.3);
      --demo-border: #374151;
      --demo-muted: #9ca3af;
      --demo-input-bg: #374151;
      --demo-input-border: #4b5563;
    }

    /* Force light mode TREF vars when NOT html.dark (overrides system dark) */
    html:not(.dark) {
      --tref-menu-bg: #ffffff;
      --tref-menu-text: #374151;
      --tref-menu-hover: #f3f4f6;
      --tref-menu-shadow: 0 4px 12px rgba(0,0,0,0.15);
      --tref-receiver-bg: #f9fafb;
      --tref-receiver-text: #6b7280;
      --tref-receiver-active-bg: #f3e8ff;
      --tref-receiver-success-bg: #ecfdf5;
      --tref-receiver-error-bg: #fef2f2;
      --tref-receiver-block-bg: #ffffff;
    }

    /* Force dark mode TREF vars when html.dark (overrides system light) */
    html.dark {
      --tref-menu-bg: #1f2937;
      --tref-menu-text: #e5e7eb;
      --tref-menu-hover: #374151;
      --tref-menu-shadow: 0 4px 12px rgba(0,0,0,0.4);
      --tref-receiver-bg: #1f2937;
      --tref-receiver-text: #9ca3af;
      --tref-receiver-active-bg: #3b2d5e;
      --tref-receiver-success-bg: #064e3b;
      --tref-receiver-error-bg: #450a0a;
      --tref-receiver-block-bg: #111827;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: var(--demo-bg);
      color: var(--demo-text);
      transition: background 0.3s, color 0.3s;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    h1 {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--demo-heading);
      margin: 0;
    }

    h1 svg { width: 40px; height: 40px; }

    .theme-toggle {
      background: var(--demo-card-bg);
      border: 2px solid var(--demo-border);
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      color: var(--demo-text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .theme-toggle:hover {
      border-color: #5CCCCC;
    }

    .article {
      background: var(--demo-card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--demo-card-shadow);
    }

    .article-content {
      line-height: 1.6;
    }

    .article-content h2 {
      margin-top: 0;
      color: var(--demo-heading);
    }

    .article-refs {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--demo-border);
      font-size: 14px;
      color: var(--demo-muted);
    }

    .article-refs a {
      color: #5CCCCC;
      text-decoration: none;
    }

    .article-refs a:hover {
      text-decoration: underline;
    }

    .article-tref {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--demo-border);
    }

    .editor {
      background: var(--demo-card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--demo-card-shadow);
    }

    .editor h2 {
      margin-top: 0;
      color: var(--demo-heading);
      border-bottom: 2px solid #5CCCCC;
      padding-bottom: 10px;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid var(--demo-input-border);
      background: var(--demo-input-bg);
      color: var(--demo-text);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #5CCCCC;
    }

    button.primary {
      background: #2D1B4E;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    button.primary:hover { background: #3d2a5e; }

    .drop-section {
      background: var(--demo-card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--demo-card-shadow);
    }

    .drop-section h2 {
      margin-top: 0;
      color: var(--demo-heading);
    }

    .drop-section p {
      color: var(--demo-muted);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2D1B4E;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    label {
      color: var(--demo-muted);
      font-size: 14px;
      margin-bottom: 8px;
      display: block;
    }
  </style>
  <style id="tref-styles"></style>
</head>
<body>
  <header>
    <h1>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
        <rect x="6" y="6" width="88" height="88" rx="12" ry="12" fill="#2D1B4E" stroke="#5CCCCC" stroke-width="5"/>
        <g transform="translate(50 50) scale(0.022) translate(-1125 -1125)">
          <g transform="translate(0,2250) scale(1,-1)" fill="#5CCCCC">
            <path d="M1515 2244 c-66 -10 -144 -38 -220 -77 -67 -35 -106 -67 -237 -195 -155 -152 -188 -195 -188 -247 0 -41 30 -95 64 -116 39 -24 113 -25 146 -3 14 9 90 81 170 160 183 181 216 199 350 199 83 0 103 -4 155 -28 78 -36 146 -104 182 -181 24 -53 28 -73 28 -151 0 -137 -21 -175 -199 -355 -79 -80 -151 -156 -160 -170 -39 -59 -8 -162 58 -194 81 -38 113 -22 284 147 165 163 230 252 268 370 24 71 28 99 28 202 0 106 -3 130 -28 200 -91 261 -310 428 -579 439 -50 3 -105 2 -122 0z"/>
            <path d="M1395 1585 c-17 -9 -189 -174 -382 -368 -377 -378 -383 -385 -362 -461 21 -76 87 -116 166 -101 33 6 80 49 386 353 191 191 358 362 369 381 26 42 28 109 4 146 -39 59 -118 81 -181 50z"/>
            <path d="M463 1364 c-47 -24 -323 -310 -365 -379 -20 -33 -49 -96 -64 -140 -24 -69 -28 -96 -28 -195 0 -127 14 -190 66 -294 63 -126 157 -220 284 -284 104 -52 167 -66 294 -66 99 0 126 4 195 28 44 15 107 44 140 64 65 39 348 309 371 354 41 78 -10 184 -96 203 -61 13 -98 -11 -256 -166 -186 -183 -222 -204 -359 -204 -77 0 -98 4 -147 27 -79 37 -142 98 -181 177 -29 59 -32 74 -32 156 0 136 21 174 199 355 79 80 150 156 159 170 23 33 22 107 -2 146 -35 57 -115 79 -178 48z"/>
          </g>
        </g>
      </svg>
      TREF Demo
    </h1>
    <button class="theme-toggle" onclick="toggleTheme()">
      <span id="theme-icon">üåô</span>
      <span id="theme-label">Dark</span>
    </button>
  </header>

  <div id="sr-announcements" class="sr-only" aria-live="polite"></div>

  <!-- SHA Validation Demo -->
  <section class="editor" style="margin-bottom: 24px;">
    <h2>SHA-256 Validation Demo</h2>
    <p style="color: var(--demo-muted); margin-bottom: 16px;">Two blocks with the same original ID - one authentic, one modified:</p>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
      <div class="article" style="margin: 0;">
        <h3 style="color: var(--demo-heading); margin-top: 0;">Original (Valid)</h3>
        <p style="line-height: 1.6;">The sky is blue due to Rayleigh scattering.</p>
        <div class="article-tref" id="valid-tref"></div>
      </div>

      <div class="article" style="margin: 0;">
        <h3 style="color: var(--demo-heading); margin-top: 0;">Tampered (Invalid)</h3>
        <p style="line-height: 1.6;">The sky is <strong>green</strong> due to Rayleigh scattering.</p>
        <div class="article-tref" id="invalid-tref"></div>
      </div>
    </div>
  </section>

  <article class="article" id="article-block" style="display: none;">
    <div class="article-content" id="article-content"></div>
    <div class="article-refs" id="article-refs"></div>
    <div class="article-tref" id="article-tref"></div>
  </article>

  <div class="editor">
    <h2>Create Article</h2>
    <textarea id="content-input" rows="8">## What is TREF?

TREF (Traceable Reference Format) is an open format for knowledge with traceable origin.

The chain link icon in the corner IS the block. Hover for actions, drag to share.</textarea>

    <label>References (one per line)</label>
    <textarea id="refs-input" rows="2" placeholder="https://example.com">https://tref.lpmwfx.com
https://en.wikipedia.org/wiki/Content-addressable_storage</textarea>

    <div style="margin-top: 16px;">
      <button class="primary" onclick="createArticle()">Publish</button>
    </div>
  </div>

  <div class="drop-section">
    <h2>Drop Zone</h2>
    <p>Drag a TREF block here to view it:</p>
    <div id="drop-zone" data-placeholder="Drop TREF block here"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import {
      TrefWrapper,
      TrefReceiver,
      wrap,
      TREF_MIME_TYPE
    } from '../dist/tref-block.js';

    // Inject wrapper styles
    document.getElementById('tref-styles').textContent =
      TrefWrapper.getStyles() + TrefReceiver.getStyles();

    // Theme toggle
    window.toggleTheme = function() {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      document.getElementById('theme-label').textContent = isDark ? 'Light' : 'Dark';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };

    // Load saved theme
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
      document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
      document.getElementById('theme-label').textContent = 'Light';
    }

    // Simple markdown to HTML
    function renderMarkdown(md) {
      return md
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        .replace(/^(.+)$/gm, (m) => m.startsWith('<') ? m : `<p>${m}</p>`);
    }

    // Crypto helpers
    function sortKeys(obj) {
      if (Array.isArray(obj)) return obj.map(sortKeys);
      if (obj !== null && typeof obj === 'object') {
        const sorted = {};
        for (const key of Object.keys(obj).sort()) sorted[key] = sortKeys(obj[key]);
        return sorted;
      }
      return obj;
    }

    async function sha256(data) {
      const buffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(data));
      return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ID is SHA-256 of content only (for content-addressability)
    async function generateId(block) {
      return `sha256:${await sha256(block.content)}`;
    }

    // Toast
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    // Create article with TREF block
    window.createArticle = async function() {
      const content = document.getElementById('content-input').value.trim();
      const refsText = document.getElementById('refs-input').value.trim();

      if (!content) {
        showToast('Enter some content');
        return;
      }

      const refs = refsText.split('\n')
        .map(l => l.trim())
        .filter(l => l.startsWith('http'))
        .map(url => ({ type: 'url', url }));

      const draft = {
        v: 1,
        content,
        meta: { created: new Date().toISOString(), license: 'CC0-1.0' },
        refs: refs.length ? refs : undefined
      };

      const id = await generateId(draft);
      const block = { ...draft, id };
      const wrapper = wrap(block);

      document.getElementById('article-block').style.display = 'block';
      document.getElementById('article-content').innerHTML = renderMarkdown(content);

      const refsEl = document.getElementById('article-refs');
      if (refs.length) {
        refsEl.innerHTML = '<strong>References:</strong><br>' +
          refs.map(r => `<a href="${r.url}" target="_blank">${r.url}</a>`).join('<br>');
        refsEl.style.display = 'block';
      } else {
        refsEl.style.display = 'none';
      }

      const trefEl = document.getElementById('article-tref');
      trefEl.innerHTML = wrapper.toHTML();
      // Add history attribute for demo
      trefEl.querySelector('.tref-wrapper').dataset.history = 'history-demo.json';
      wrapper.attachEvents(trefEl.querySelector('.tref-wrapper'));

      showToast('Published: ' + wrapper.shortId);
    };

    // Drop zone
    new TrefReceiver(document.getElementById('drop-zone'), {
      onReceive: (wrapper) => {
        showToast('Received: ' + wrapper.shortId);

        const content = wrapper.content;
        const refs = wrapper.block.refs || [];

        document.getElementById('article-block').style.display = 'block';
        document.getElementById('article-content').innerHTML = renderMarkdown(content);

        const refsEl = document.getElementById('article-refs');
        if (refs.length) {
          refsEl.innerHTML = '<strong>References:</strong><br>' +
            refs.map(r => `<a href="${r.url}" target="_blank">${r.url}</a>`).join('<br>');
          refsEl.style.display = 'block';
        } else {
          refsEl.style.display = 'none';
        }

        const trefEl = document.getElementById('article-tref');
        trefEl.innerHTML = wrapper.toHTML();
        // Add history attribute for demo
        trefEl.querySelector('.tref-wrapper').dataset.history = 'history-demo.json';
        wrapper.attachEvents(trefEl.querySelector('.tref-wrapper'));
      },
      onError: () => showToast('Invalid TREF data')
    });

    // Auto-create on load
    createArticle();

    // SHA Validation Demo - create valid and invalid blocks
    async function setupValidationDemo() {
      const originalContent = 'The sky is blue due to Rayleigh scattering.';
      const tamperedContent = 'The sky is green due to Rayleigh scattering.';

      // Create a valid block (content matches ID)
      const validBlock = {
        v: 1,
        content: originalContent,
        meta: { created: '2026-01-08T10:00:00Z', license: 'CC0-1.0' },
        refs: [{ type: 'url', url: 'https://en.wikipedia.org/wiki/Rayleigh_scattering' }]
      };
      validBlock.id = await generateId(validBlock);

      // Create an invalid block (content was tampered but ID is from original)
      const invalidBlock = {
        v: 1,
        id: validBlock.id, // Using the ORIGINAL id
        content: tamperedContent, // But content was changed!
        meta: { created: '2026-01-08T10:00:00Z', license: 'CC0-1.0' },
        refs: [{ type: 'url', url: 'https://en.wikipedia.org/wiki/Rayleigh_scattering' }]
      };

      // Render valid block
      const validWrapper = wrap(validBlock);
      const validEl = document.getElementById('valid-tref');
      validEl.innerHTML = validWrapper.toHTML();
      validWrapper.attachEvents(validEl.querySelector('.tref-wrapper'));

      // Render invalid block
      const invalidWrapper = wrap(invalidBlock);
      const invalidEl = document.getElementById('invalid-tref');
      invalidEl.innerHTML = invalidWrapper.toHTML();
      invalidWrapper.attachEvents(invalidEl.querySelector('.tref-wrapper'));
    }

    setupValidationDemo();
  </script>
</body>
</html>
