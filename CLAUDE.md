# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

TREF (Traceable Reference Format) is an open, transportable, and verifiable block format for preserving, validating, and reusing knowledge with traceable source origin. It's a knowledge-bearing object format (not a CMS or AI model) where content, metadata, licenses, references, and history are combined in self-contained units.

## Architecture: Single Source Principle

**One source, many outputs.** All UI components live in `src/` and are built to `dist/`. Nothing is hardcoded or copied.

```
src/wrapper/wrapper.js    ← SINGLE SOURCE OF TRUTH
        │
    npm run build
        ▼
dist/tref-block.js        ← Built output
        │
        ├──> CDN (jsdelivr/unpkg)
        └──> npm install tref-block
```

### Directory Structure

```
TRefBlocks/
├── src/                  # SOURCE - the only place code is written
│   ├── wrapper/          #   UI components (wrapper.js)
│   ├── cli/              #   CLI tool
│   ├── mcp/              #   MCP server
│   └── index.js          #   Main entry, schemas
│
├── dist/                 # BUILT - generated by npm, never edited
│   └── tref-block.js     #   ES module bundle
│
├── demo/                 # DEMO - imports from dist/
│   └── index.html        #   Visual testing page
│
├── docs/                 # SITE - GitHub Pages (tref.lpmwfx.com)
│
└── doc/                  # DOCUMENTATION - project docs
    ├── project.md        #   Project overview
    └── TrefBlockUIUX.md  #   UI/UX specification
```

## Commands

```bash
# Build browser library (src/ → dist/)
npm run build:browser     # Bundles wrapper.js to dist/tref-block.js

# Full build (browser + CLI)
npm run build             # All build targets

# Development server
npm run dev               # Serves on http://localhost:8080

# Quality checks
npm run check             # typecheck + lint + format check
npm run typecheck         # TypeScript checking (no emit)
npm run lint              # ESLint
npm run format:check      # Prettier check

# Fix/format
npm run lint:fix          # ESLint --fix
npm run format            # Prettier --write

# Run tests
npm test                  # node --test
```

## Development Approach: TypeScript-Level Safety in Pure JavaScript

This project uses ES2024 JavaScript with JSDoc type annotations, validated by TypeScript CLI without transpilation.

**The safety stack:**
- **JSDoc** → Static types via comments
- **TypeScript CLI** → Type checking (no emit)
- **ESLint + typescript-eslint** → Type-aware linting
- **Zod** → Runtime validation at boundaries
- **Prettier** → Formatting

## Code Patterns

### Type Annotations (JSDoc)

```javascript
/** @typedef {z.infer<typeof SomeSchema>} SomeType */

/**
 * @param {unknown} data - Use unknown for external input
 * @returns {SomeType}
 */
function parse(data) {
  return SomeSchema.parse(data);
}
```

### Runtime Validation with Zod

Use Zod schemas for all external data boundaries. Derive types from schemas using `z.infer<typeof Schema>`.

```javascript
const Schema = z.object({
  id: z.string().uuid(),
  type: z.enum(['text', 'code', 'image']),
});

/** @typedef {z.infer<typeof Schema>} MyType */
```

## Integration

**CDN (recommended for websites):**
```html
<script type="module">
  import { TrefWrapper } from 'https://cdn.jsdelivr.net/npm/tref-block';
</script>
```

**npm (for JS projects):**
```bash
npm install tref-block
```
```javascript
import { TrefWrapper } from 'tref-block';
```

## CSS Architecture

**Single source for CSS too.** All site styles live in `docs/css/tref-site.css`. No inline `<style>` blocks in HTML.

### Principles

1. **Grouped selectors** - Multiple class names can share one definition:
   ```css
   .card,
   .explainer,
   .builder-form,
   .result-preview {
     background: var(--site-card-bg);
     border-radius: 12px;
     padding: 2rem;
   }
   ```

2. **CSS variables for theming** - All colors via custom properties:
   ```css
   :root {
     --site-card-bg: #fff;
   }
   html.dark {
     --site-card-bg: #1e293b;
   }
   ```

3. **Cascade, not duplication** - Base patterns → modifiers → component-specific

4. **No inline styles in HTML** - Use utility classes (.mt-2, .text-center) or add to CSS file

### File Structure

```
docs/css/tref-site.css    ← ALL site styles (single file)
    1. Variables (:root, html.dark)
    2. Base reset
    3. Layout (.container, .section)
    4. Navigation
    5. Hero
    6. Box pattern (.card, .explainer, etc.)
    7. Badge pattern (.card-icon, .list-icon)
    8. Grid pattern (.card-grid, .comparison)
    9. Lists
   10. Buttons
   11. Code blocks
   12. Forms
   13. Component-specific
   14. Footer
   15. Responsive
   16. Utilities
```

## Identity Rule

**lpmwfx is the public identity.** Use "lpmwfx" for all public-facing content:
- Author fields (package.json, LICENSE)
- Copyright notices
- URLs and links

**Never use "lpm" alone** in any tracked file - it's the private identity.

## Language Rule

**All content in English before push.** Translate any Danish text in code, docs, and project files to English before committing/pushing.

## Release Process

When releasing a new version:

1. **Update version** in `package.json`
2. **Update CHANGELOG** with new features
3. **Update cache-busting strings** in all docs HTML files:
   ```bash
   find docs -name "*.html" -exec sed -i 's/?v=OLD/?v=NEW/g' {} \;
   ```
   Files use `?v=X.Y.Z` on CSS/JS imports to force browser cache refresh.
4. **Build and test**: `npm run build && npm test`
5. **Commit and tag**:
   ```bash
   git add -A && git commit -m "Release vX.Y.Z"
   git tag -a vX.Y.Z -m "vX.Y.Z - description"
   git push origin main --tags
   ```
6. **Create GitHub release** with release notes:
   ```bash
   gh release create vX.Y.Z --title "vX.Y.Z - Title" --notes "..."
   ```

## ID Generation

**Block IDs use content-only SHA-256 hashing.** The ID is the hash of the `content` field only (not the entire block). This enables simple browser-side validation: hash content, compare to ID.
